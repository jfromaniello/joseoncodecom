--- 
layout: post
title: Understanding JQuery.Deferred and Promise
tags: 
- javascript
- jquery
status: publish
type: post
published: true
meta: 
  dsq_thread_id: "426242939"
---
<p>
    <strong>Please read my new and more accurate blog post about promises first: <a href="http://joseoncode.com/2013/05/23/promises-a-plus/">here</a></strong>
</p>
<blockquote>   <p>Notice this blog post has lot of runnable examples in Javascript, but it might not work on a rss reader.</p> </blockquote>  <p>JQuery 1.5 introduced the concept of “Deferred”, you can read more about it <a href="http://api.jquery.com/category/deferred-object/">here</a>. I find this concept very powerful when working with Javascript and ajax, and I think is a game changer to the way we are used to write asynchronous code in js.</p>  <p>Usually, the way we are used to deal with asynchronous code in Javascript is passing callbacks as an argument to the function:</p> <iframe style="width: 100%; height: 212px" src="http://jsfiddle.net/jfromaniello/D5mrn/3/embedded/"></iframe>  <p>As you can see here we are passing two callbacks (success and error) to the $.ajax method using the object-literal syntax that the method support.</p>  <p>This work but it is not an standard interface, it requires some work inside the post method and we can't register multiple callbacks.</p>  <h1>Introducing $.Deferred</h1>  <p>The deferred object is pretty easy to understand yet powerful. It has two important methods: </p>  <ul>   <li>resolve </li>    <li>reject </li> </ul>  <p>And it has three important “events” or ways to attach a callback:</p>  <ul>   <li>done </li>    <li>fail </li>    <li>always </li> </ul>  <p>so a basically dumb example will be something like this (you can run this right here):</p> <iframe style="width: 100%; height: 153px" src="http://jsfiddle.net/jfromaniello/EKK6E/75/embedded/"></iframe>  <p>   <br />If you call the &quot;reject&quot; method the fail callback attached will be executed, the always callback is executed whether the deferred is resolved or rejected.</p>  <p>Another interesting point is that if you attach a callback to an already resolved deferred, it get executes immediately:</p>  <p><iframe style="width: 100%; height: 153px" src="http://jsfiddle.net/jfromaniello/9zcVB/2/embedded/"></iframe></p>  <h1>The Promise() method</h1>  <p>The Deferred object has another important method named Promise(). This method returns an object with almost the same interface than the Deferred, but it only have the methods to attach callbacks and does not have the methods to resolve and reject.</p>  <p>This is useful when you want to give to the calling API something to subscribe to, but not the ability to resolve or reject the deferred. This code will fail because the promise doesn't have a method &quot;resolve&quot;: </p> <iframe style="width: 100%; height: 200px" src="http://jsfiddle.net/jfromaniello/PdCyT/5/embedded/"></iframe>  <p>   <br />The $.ajax method in JQuery returns a Promise, so you can do:</p> <iframe style="width: 100%; height: 244px" src="http://jsfiddle.net/jfromaniello/M4EPf/2/embedded/"></iframe>  <p>This code does the same than the first snippet with the only difference that you can add as many callbacks as you want, the syntax is clear because we don’t need an extra parameter in the method. On the other hand you can use the promise as a return value of other function and one of the most interesting things for me is that you can do some operations with the promises.</p>  <h1>The Pipe() method</h1>  <p>The Pipe method is very powerful and useful, it allows you to “project” a promise. </p>  <p>Following the former example, we can do something like this:</p> <iframe style="width: 100%; height: 186px" src="http://jsfiddle.net/jfromaniello/sZLCX/1/embedded/"></iframe>  <p>   <br />Here we are doing a projection of the result which is a “person” object. So, instead of having a Deferred of person, we have now a deferred of “Saved {firstName}”.</p>  <p>Another very interesting feature of the pipe method is that you can return a deferred from inside the pipe callback. Imagine that we have two methods, one to get a Customer SSN by an internal id fiscal and another one to get a Person’s address by SSN:</p> <iframe style="width: 100%; height: 455px" src="http://jsfiddle.net/jfromaniello/yBThB/1/embedded/"></iframe>  <p>As you can see here, I added a new method “getPersonAddressByID”. This method return a deferred which is a combination of the two methods. If one of the methods in the pipeline fails the “master” deferred will fail.</p>  <p>Pipelines has some other usages, for instance, you can reject the deferred inside the pipe callback.</p>  <p>Another interesting use case that I can think of for pipes, are recursive deferred. Imagine that you started an asynchronous operation in the backend, and you need to do “polling” to see if the task is done and when the task is done do something else;</p> <iframe style="width: 100%; height: 677px" src="http://jsfiddle.net/jfromaniello/g7YnU/36/embedded/"></iframe>  <h1>Combining promises with $.when</h1>  <p>Another very useful method is $.when. The method accepts an arbitrary number of promises, and it returns a master deferred that:</p>  <ul>   <li>will be “resolved” when all the promises are resolved, </li>    <li>will be rejected if any of the promises is rejected, </li> </ul>  <p>The done callback has the results of all the promises. </p>  <p>This is an example:</p> <iframe style="width: 100%; height: 406px" src="http://jsfiddle.net/jfromaniello/FPqc4/7/embedded/"></iframe>  <p>As you can see at the end of this example, then $.when returns a new deferred and we are using the two results in the done callback. </p>  <p>Notice that I changed the getCustomer method; this is because the promise of an ajax call, has the content payload as first element in the result, but also has other stuff like the status code.</p>  <p>In this&#160; you can mix $.when and pipes as follows: </p> <iframe style="width: 100%; height: 453px" src="http://jsfiddle.net/jfromaniello/UxT7e/2/embedded/"></iframe>  <p>&#160;</p>  <p>Another interesting use case for the $.when operator, is when you need to load several things in the screen but you want only one big-loading message:</p> <iframe style="width: 100%; height: 651px" src="http://jsfiddle.net/jfromaniello/AjwaV/40/embedded/"></iframe>  <p>&#160;</p>  <p>There are other useful methods and ways you can combine deferred I strongly encourage to read about those in the jquery documentation. </p>  <p>This is all for now! I hope you find this post useful. </p>
